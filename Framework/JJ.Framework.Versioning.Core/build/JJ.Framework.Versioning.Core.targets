<Project>
  
  <!-- Import the .props file with the BuildNum in it. For some reason it doesn't work without explicitly importing it here, despite also being loaded before Build. -->  
  <Import Project="$(MSBuildProjectDirectory)\build\JJ.Framework.Versioning.Core.props" Condition="Exists('$(MSBuildProjectDirectory)\build\JJ.Framework.Versioning.Core.props')" />
  
  <!-- Load before build -->
  <Target Name="JJAutoIncrementVersionLoad" BeforeTargets="Build">
    
    <!-- Info message -->
    <Message Text="JJ AUTO-INCREMENT VERSION LOAD -> $(MSBuildThisFileDirectory)JJ.Framework.Versioning.Core.props" Importance="High" Condition="Exists('$(MSBuildProjectDirectory)\build\JJ.Framework.Versioning.Core.props')" />
    
    <!-- Copy project-bound props file. with BuildNum in it, to package bound location, to make it be imported on time, before the csproj loads. -->
    <Copy 
      SourceFiles="$(MSBuildProjectDirectory)\build\JJ.Framework.Versioning.Core.props"
      DestinationFiles="$(MSBuildThisFileDirectory)\JJ.Framework.Versioning.Core.props"
      Condition="Exists('$(MSBuildProjectDirectory)\build\JJ.Framework.Versioning.Core.props')"/>
  
  </Target>
    
  <!-- Save after buid -->
  <Target Name="JJAutoIncrementVersionSave" AfterTargets="Build">
    
    <!-- Info message -->
    <Message Text="JJ AUTO-INCREMENT VERSION SAVE -> $(MSBuildProjectDirectory)\build\JJ.Framework.Versioning.Core.props" Importance="High" />
    
    <!-- Default empty BuildNum to 0 before incrementing. -->
    <PropertyGroup><BuildNum Condition="'$(BuildNum)' == ''">0</BuildNum></PropertyGroup>
    
    <!-- Increment BuildNum, then assign back to BuildNum. -->
    <PropertyGroup><BuildNum>$([MSBuild]::Add($(BuildNum), 1))</BuildNum></PropertyGroup>
    
    <!-- Write the new BuildNum to an MSBuild props file. -->
    <WriteLinesToFile File="$(MSBuildProjectDirectory)\build\JJ.Framework.Versioning.Core.props" Lines="&lt;Project&gt;&lt;PropertyGroup&gt;&lt;BuildNum&gt;$(BuildNum)&lt;/BuildNum&gt;&lt;/PropertyGroup&gt;&lt;/Project&gt;" Overwrite="true" Encoding="UTF-8" />
  </Target>

</Project>