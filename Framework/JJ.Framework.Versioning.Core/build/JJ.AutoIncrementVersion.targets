<Project>
  
  <!-- Helper Variables -->
  
  <PropertyGroup>
    <VerName>JJ.AutoIncrementVersion.ver</VerName>
    <Ver>$(MSBuildProjectDirectory)\$(VerName)</Ver>
    <Init>$(Ver).init</Init>
    <Props>$(MSBuildThisFileDirectory)\JJ.AutoIncrementVersion.props</Props>
    <DirectoryProps>$(MSBuildProjectDirectory)\Directory.Build.props</DirectoryProps>
  </PropertyGroup>
  
  <!-- State -->

  <Import Project="$(Ver)" Condition="'$(BuildNum)' == '' and Exists('$(Ver)')" />
  <Import Project="$(Init)" Condition="'$(BuildNum)' == '' and Exists('$(Init)')" />

  <!-- Init  -->
  
  <!-- Write DirectoryProps containing BuildNum for fallback after uninstall. -->
  <Target Condition="!Exists('$(DirectoryProps)')" Name="JJAutoIncrementVersion_Init1" BeforeTargets="Build">
    <Message Text="JJ AUTO-INCREMENT VERSION INIT -> $(DirectoryProps)" Importance="High" />
    <WriteLinesToFile 
      File="$(DirectoryProps)" 
      Lines="&lt;Project&gt;&lt;Import Project=&quot;$(VerName)&quot; Condition=&quot;'%24(BuildNum)' == '' and Exists('$(VerName)')&quot;/&gt;&lt;/Project&gt;" />
  </Target>
  
  <!-- Initial ver upon first build. -->
  <Target Condition="!Exists('$(Ver)')" Name="JJAutoIncrementVersion_Init2" BeforeTargets="Build">
    <Message Text="JJ AUTO-INCREMENT VERSION INIT -> $(Ver)" Importance="High" />
    <WriteLinesToFile 
      File="$(Ver)"
      Lines="&lt;Project&gt;&lt;PropertyGroup&gt;&lt;BuildNum&gt;0&lt;/BuildNum&gt;&lt;/PropertyGroup&gt;&lt;/Project&gt;" />
  </Target>
  
  <!-- Load before build -->
  
  <Target Condition="Exists('$(Ver)')" Name="JJAutoIncrementVersion_Load" BeforeTargets="Build">
    <Message Text="JJ AUTO-INCREMENT VERSION LOAD -> $(Props)" Importance="High"  />
    <!-- Copy project-bound props file
         to package bound location, to make BuildNum imported on time, for use in csproj. -->
    <Copy SourceFiles="$(Ver)" DestinationFiles="$(Props)" />
  </Target>
    
  <!-- Save after buid -->
  
  <!-- NOTE: Trying BeforeTargets intead of AfterTargets,
             hoping the project will be seen as "up-to-date" despite us writing in it. Seemed ineffective, but here's to hoping. -->
  
  <Target Name="JJAutoIncrementVersion_Save" AfterTargets="Build">
    <Message Text="JJ AUTO-INCREMENT VERSION SAVE -> $(Ver)" Importance="High" />
    
    <!-- BuildNum default 0 -->
    <PropertyGroup><BuildNum Condition="'$(BuildNum)' == ''">0</BuildNum></PropertyGroup>
    
    <!-- Increment -->
    <PropertyGroup><BuildNum>$([MSBuild]::Add($(BuildNum), 1))</BuildNum></PropertyGroup>
    
    <!-- Write to ver file -->
    <WriteLinesToFile 
      File="$(Ver)" Overwrite="true"
      Lines="&lt;Project&gt;&lt;PropertyGroup&gt;&lt;BuildNum&gt;$(BuildNum)&lt;/BuildNum&gt;&lt;/PropertyGroup&gt;&lt;/Project&gt;" />
  </Target>

  <!-- Clean Up -->
  
  <!-- Delete BuildNum from package dir, aiming not to trigger dependencies to build again. -->
  <Target Condition="Exists('$(Props)')" Name="JJAutoIncrementVersion_CleanUp" AfterTargets="Build"> 
    <Message Text="JJ AUTO-INCREMENT VERSION DELETE -> $(Props)" Importance="High" />
    <Delete Files="$(Props)" />
  </Target>
    
</Project>