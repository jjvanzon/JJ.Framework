<Project>
  
  <!-- State -->

  <Import Project="$(MSBuildProjectDirectory)\JJ.AutoIncrementVersion.ver" 
          Condition="Exists('$(MSBuildProjectDirectory)\JJ.AutoIncrementVersion.ver')" />

  <Import Project="$(MSBuildProjectDirectory)\JJ.AutoIncrementVersion.ver.init" 
          Condition="'$(BuildNum)' == '' and Exists('$(MSBuildProjectDirectory)\JJ.AutoIncrementVersion.ver.init')" />

  <!-- Init  -->
  
  <!-- Fallback $(BuildNum) ref for after uninstall. -->
  <Target Name="JJAutoIncrementVersion_Init1" BeforeTargets="Build"
          Condition="!Exists('$(MSBuildProjectDirectory)\Directory.Build.props')">

    <!-- Info message -->
    <Message Text="JJ AUTO-INCREMENT VERSION INIT -> $(MSBuildProjectDirectory)\Directory.Build.props" Importance="High" />

    <!-- Write "Directory.Build.props" -->
    <WriteLinesToFile
      File="$(MSBuildProjectDirectory)\Directory.Build.props"
      Lines="
&lt;Project&gt;
  &lt;Import Project=&quot;JJ.AutoIncrementVersion.ver&quot; Condition=&quot;Exists('JJ.AutoIncrementVersion.ver')&quot;/&gt;
&lt;/Project&gt;" />
<!--&lt;Import Project=&quot;JJ.AutoIncrementVersion.ver.init&quot; Condition=&quot;Exists('JJ.AutoIncrementVersion.ver.init')&quot;/&gt;-->
  </Target>
  
  <!-- Initial ver upon first build. -->
  <Target Name="JJAutoIncrementVersion_Init2" BeforeTargets="Build"
          Condition="!Exists('$(MSBuildProjectDirectory)\JJ.AutoIncrementVersion.ver')" >

    <!-- Info message -->
    <Message Text="JJ AUTO-INCREMENT VERSION INIT -> $(MSBuildProjectDirectory)\JJ.AutoIncrementVersion.ver" Importance="High" />

    <!-- Install initial ver file. -->
    <WriteLinesToFile 
      File="$(MSBuildProjectDirectory)\JJ.AutoIncrementVersion.ver"
      Lines="&lt;Project&gt;&lt;PropertyGroup&gt;&lt;BuildNum&gt;0&lt;/BuildNum&gt;&lt;/PropertyGroup&gt;&lt;/Project&gt;" />
  </Target>
  
  <!-- Load before build -->
  
  <Target Name="JJAutoIncrementVersion_Load" BeforeTargets="Build"
          Condition="Exists('$(MSBuildProjectDirectory)\JJ.AutoIncrementVersion.ver')">
    
    <!-- Info message -->
    <Message Text="JJ AUTO-INCREMENT VERSION LOAD -> $(MSBuildThisFileDirectory)JJ.AutoIncrementVersion.props" Importance="High"  />
    
    <!-- Copy project-bound props file
         to package bound location, to make BuildNum imported on time, for use in csproj. -->
    <Copy 
      SourceFiles="$(MSBuildProjectDirectory)\JJ.AutoIncrementVersion.ver"
      DestinationFiles="$(MSBuildThisFileDirectory)\JJ.AutoIncrementVersion.props" />
  </Target>
    
  <!-- Save after buid -->
  
  <!-- NOTE: Trying BeforeTargets intead of AfterTargets,
             hoping the project will be seen as "up-to-date" despite us writing in it. Seemed ineffective, but here's to hoping. -->
  
  <Target Name="JJAutoIncrementVersion_Save" AfterTargets="Build"> <!--BeforeTargets="Build">-->
    
    <!-- Info message -->
    <Message Text="JJ AUTO-INCREMENT VERSION SAVE -> $(MSBuildProjectDirectory)\JJ.AutoIncrementVersion.ver" Importance="High" />
    
    <!-- Default empty BuildNum to 0 before incrementing. -->
    <PropertyGroup><BuildNum Condition="'$(BuildNum)' == ''">0</BuildNum></PropertyGroup>
    
    <!-- Increment BuildNum, then assign back to BuildNum. -->
    <PropertyGroup><BuildNum>$([MSBuild]::Add($(BuildNum), 1))</BuildNum></PropertyGroup>
    
    <!-- Write the new BuildNum to an MSBuild props file. -->
    <WriteLinesToFile 
      File="$(MSBuildProjectDirectory)\JJ.AutoIncrementVersion.ver" Overwrite="true"
      Lines="&lt;Project&gt;&lt;PropertyGroup&gt;&lt;BuildNum&gt;$(BuildNum)&lt;/BuildNum&gt;&lt;/PropertyGroup&gt;&lt;/Project&gt;" />
  </Target>

  <!-- Clean Up -->
  
  <Target Name="JJAutoIncrementVersion_CleanUp" AfterTargets="Build"
          Condition="Exists('$(MSBuildThisFileDirectory)\JJ.AutoIncrementVersion.props')"> 
    
    <!-- Info message -->
    <Message Text="JJ AUTO-INCREMENT VERSION DELETE -> $(MSBuildThisFileDirectory)\JJ.AutoIncrementVersion.props" Importance="High" />

    <!-- Delete BuildNum from package dir, to not trigger dependencies to build again. -->
    <Delete Files="$(MSBuildThisFileDirectory)\JJ.AutoIncrementVersion.props" />
  </Target>
    
</Project>