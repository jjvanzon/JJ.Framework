<Project>
  
  <!-- Vars -->

  <PropertyGroup>
    <VerFileNameJj>JJ.AutoIncrementVersion.xml</VerFileNameJj>
            <VerJj>$(MSBuildProjectDirectory)\..\$(VerFileNameJj)</VerJj>
          <PropsJj>$(MSBuildThisFileDirectory)\JJ.AutoIncrementVersion.props</PropsJj>
       <DirPropsJj>$(MSBuildProjectDirectory)\Directory.Build.props</DirPropsJj>
  </PropertyGroup>
  
  <PropertyGroup>
     <ToolNameJj>JJ AUTO-INCREMENT VERSION</ToolNameJj>
      <InitMsgJj>$(ToolNameJj) INIT</InitMsgJj>
      <LoadMsgJj>$(ToolNameJj) LOAD</LoadMsgJj>
      <SaveMsgJj>$(ToolNameJj) SAVE</SaveMsgJj>
    <DeleteMsgJj>$(ToolNameJj) DELETE</DeleteMsgJj>
  </PropertyGroup>
    
  <PropertyGroup>
    <DirPropLinesJj>&lt;Project&gt;&lt;Import Project=&quot;..\$(VerFileNameJj)&quot; Condition=&quot;'%24(BuildNum)' == '' and Exists('..\$(VerFileNameJj)')&quot;/&gt;&lt;/Project&gt;</DirPropLinesJj>
  </PropertyGroup>

  <!-- LOAD ver file. -->
  <Import Project="$(VerJj)" Condition="'$(BuildNum)' == '' and Exists('$(VerJj)' )" />
  <PropertyGroup>
    <!-- Default 0 -->
    <BuildNum Condition="'$(BuildNum)' == ''">0</BuildNum> 
    <!-- Increment -->
    <BuildNum>$([MSBuild]::Add($(BuildNum), 1))</BuildNum>
  </PropertyGroup>

  <Target Name="JJ_AutoIncrementVersion_Before" BeforeTargets="Build">
    <!-- INIT Directory.Build.props containing BuildNum for fallback after uninstall. -->
             <Message Condition="!Exists('$(DirPropsJj)')" Text="$(InitMsgJj) -> $(DirPropsJj)" Importance="High" />
    <WriteLinesToFile Condition="!Exists('$(DirPropsJj)')" File="$(DirPropsJj)" Lines="$(DirPropLinesJj)" />

    <!-- SAVE updated ver -->
    <Message Text="$(SaveMsgJj)-> $(VerJj)" Importance="High" />
    <WriteLinesToFile 
      File="$(VerJj)" Overwrite="true"
      Lines="&lt;Project&gt;&lt;PropertyGroup&gt;&lt;BuildNum&gt;$(BuildNum)&lt;/BuildNum&gt;&lt;/PropertyGroup&gt;&lt;/Project&gt;" />
    
    <!-- LOAD project-bound props file to package bound location, to make BuildNum imported on time, for use in csproj. --> 
    <Message Condition="Exists('$(VerJj)')" Text="$(LoadMsgJj) -> $(PropsJj)" Importance="High"  />
       <Copy Condition="Exists('$(VerJj)')" SourceFiles="$(VerJj)" DestinationFiles="$(PropsJj)" />
  </Target>

  <Target Name="JJAutoIncrementVersion_After" AfterTargets="Build"> 
   <!-- DELETE BuildNum from package dir, aiming not to trigger dependencies to build again. -->
    <Message Condition="Exists('$(PropsJj)')" Text="$(DeleteMsgJj) -> $(PropsJj)" Importance="High" />
     <Delete Condition="Exists('$(PropsJj)')" Files="$(PropsJj)" />
  </Target>
    
</Project>