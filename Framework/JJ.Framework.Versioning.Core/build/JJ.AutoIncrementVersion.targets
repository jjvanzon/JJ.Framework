<Project>
  
<!-- Vars -->

<PropertyGroup>
   <ToolTitlejj>JJ-AUTO-INC-VER</ToolTitlejj>
     <MsgInitjj>$(ToolTitlejj) INIT</MsgInitjj>
  <MsgContentjj>$(ToolTitlejj) CONTENT</MsgContentjj>
     <MsgLoadjj>$(ToolTitlejj) LOAD</MsgLoadjj>
     <MsgSavejj>$(ToolTitlejj) SAVE</MsgSavejj>
    <MsgStagejj>$(ToolTitlejj) STAGE</MsgStagejj>
</PropertyGroup>

<PropertyGroup>
    <ProjDirjj>$(MSBuildProjectDirectory)</ProjDirjj>
    <PackDirjj>$(MSBuildThisFileDirectory)</PackDirjj>
    <XmlNamejj>BuildNum.xml</XmlNamejj>
  <PropsNamejj>JJ.AutoIncrementVersion.props</PropsNamejj>
        <Xmljj>$(ProjDirjj)\..\$(XmlNamejj)</Xmljj>
      <Propsjj>$(PackDirjj)\$(PropsNamejj)</Propsjj>
   <DirPropsjj>$(ProjDirjj)\..\Directory.Build.props</DirPropsjj>
</PropertyGroup>
  
<PropertyGroup>
  <DirPropsContentjj>
&lt;Project&gt;
  &lt;Import 
    Project="$(XmlNamejj)" 
    Condition="'%24(XmlImportedjj)'==''
    And '%24(BuildNum)'==''
    And Exists('$(XmlNamejj)')"/&gt;
&lt;/Project&gt;
  </DirPropsContentjj>
</PropertyGroup>

<!-- LOAD -->
  
<!-- BuildNum.xml -->
  
<Import Project="$(Xmljj)" Condition="'$(XmlImportedjj)'=='' And Exists('$(Xmljj)')" />
<PropertyGroup>
  <BuildNum Condition="'$(BuildNum)'==''">0</BuildNum> <!-- Default 0 -->
  <BuildNum>$([MSBuild]::Add($(BuildNum), 1))</BuildNum> <!-- Increment -->
  <!-- New XML content -->
  <XmlContentjj>
&lt;Project&gt;
  &lt;PropertyGroup&gt;
      &lt;BuildNum&gt;$(BuildNum)&lt;/BuildNum&gt;
      &lt;XmlImportedjj&gt;True&lt;/XmlImportedjj&gt;
  &lt;/PropertyGroup&gt;
&lt;/Project&gt;
  </XmlContentjj>
  <PropsContentjj>
&lt;Project&gt;
  &lt;PropertyGroup&gt;
      &lt;BuildNum&gt;$(BuildNum)&lt;/BuildNum&gt;
  &lt;/PropertyGroup&gt;
&lt;/Project&gt;
  </PropsContentjj>
  
</PropertyGroup>

<Target Name="JJ_AutoIncrementVersion_BeforeBuild" BeforeTargets="BeforeBuild">
  
  <!-- INIT -->
  
  <!-- Auto-create Directory.Build.props that imports BuildNum.xml for fallback before package restore and after uninstall. -->
           <Message Condition="!Exists('$(DirPropsjj)')" Text="$(MsgInitjj) => &quot;$(DirPropsjj)&quot;" Importance="High" />
  <WriteLinesToFile Condition="!Exists('$(DirPropsjj)')" File="$(DirPropsjj)" Lines="$(DirPropsContentjj)" />

  <!-- CONTENT -->
  
  <ReadLinesFromFile File="$(DirPropsjj)" Condition="Exists('$(DirPropsjj)')" >
    <Output TaskParameter="Lines" PropertyName="DirPropsReadOutjj" />
  </ReadLinesFromFile>
  
  <Message Text="$(MsgContentjj) dir .props: $(DirPropsReadOutjj) &lt;= &quot;$(DirPropsjj)&quot;" Importance="High" />
  
  <ReadLinesFromFile File="$(Xmljj)" Condition="Exists('$(Xmljj)')" >
    <Output TaskParameter="Lines" PropertyName="BuildNumXmlReadOutjj" />
  </ReadLinesFromFile>
  
  <Message Text="$(MsgContentjj) .xml: $(BuildNumXmlReadOutjj) &lt;= &quot;$(Xmljj)&quot;" Importance="High" />

  <ReadLinesFromFile File="$(Propsjj)" Condition="Exists('$(Propsjj)')" >
    <Output TaskParameter="Lines" PropertyName="PropsReadOutjj" />
  </ReadLinesFromFile>
  
  <Message Text="$(MsgContentjj) .props: $(PropsReadOutjj) &lt;= &quot;$(Propsjj)&quot;" Importance="High" />

  <!-- LOADED ? -->
  
  <Message Text="$(MsgLoadjj) $(BuildNum) &lt;= .xml + 1 ?? (&quot;$(Xmljj)&quot;)" Importance="High" />
  <Message Text="$(MsgLoadjj) $(BuildNum) &lt;= .props + 1 ?? (&quot;$(Propsjj)&quot;)" Importance="High" />

  <!-- SAVE -->
  
  <!-- Updated XML -->
           <Message Text="$(MsgSavejj) $(BuildNum) => .xml &quot;$(Xmljj)&quot;" Importance="High" />
  <WriteLinesToFile File="$(Xmljj)" Overwrite="true" Lines="$(XmlContentjj)" />
  
  <!-- STAGE -->
  
  <!-- XML file => package bound .props location, to import BuildNum early enough for use in csproj. --> 
           <Message Text="$(MsgStagejj) $(BuildNum) => .props &quot;$(Propsjj)&quot;" Importance="High"  />
  <WriteLinesToFile File="$(Propsjj)" Overwrite="true" Lines="$(PropsContentjj)" />
</Target>
    
</Project>